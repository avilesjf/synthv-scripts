local SCRIPT_TITLE = '.Backup project'

--[[

Synthesizer V Studio Pro Script
 
lua file name: BackupPanel.lua

Backup project file in same svp folder with timestamp
Filename *.svp named into *_BACKUP_date_time.svp
Save notes inside project (Script data)
Delete old projects and keep MAX_AUTO_BACKUPS files (default=5 files)
Display other project script data keys if exists inside project.

Notice: Works only with script panel 
		introduced with Synthesizer V version >= 2.1.2

Update: 1 - Creation

2025 - JF AVILES
--]]

function getClientInfo()
	return {
		name = SV:T(SCRIPT_TITLE),
		-- category = "_JFA_Panels",
		author = "JFAVILES",
		versionNumber = 1,
		minEditorVersion = 131329,
		type = "SidePanelSection"
	}
end

-- Generated by JFA TranslateScripts.lua
function getTranslations(langCode)
	return getArrayLanguageStrings()[langCode]
end

-- Generated by JFA TranslateScripts.lua
function getArrayLanguageStrings()
	return {
		["en-us"] = {
			{"Version", "Version"},
			{"author", "author"},
			{"minEditorVersion", "minEditorVersion"},
			{"Backup notes loaded!", "Backup notes loaded!"},
			{"chars", "chars"},
			{"No backup notes!", "No backup notes!"},
			{"See other project keys", "See other project keys"},
			{"Scripts project keys found:", "Scripts project keys found:"},
			{"No other project keys", "No other project keys"},
			{"CLEAR backup notes, ARE YOU SURE?", "CLEAR backup notes, ARE YOU SURE?"},
			{"Cancel => to abort", "Cancel => to abort"},
			{"Backup notes cleared!", "Backup notes cleared!"},
			{"Remember to save this project!", "Remember to save this project!"},
			{"Backup project notes!", "Backup project notes!"},
			{" Click OK button to save backup notes!", " Click OK button to save backup notes!"},
			{"Backup notes saved!", "Backup notes saved!"},
			{"Clean old backup files!", "Clean old backup files!"},
			{"Click OK button to delete old backup files!", "Click OK button to delete old backup files!"},
			{"Existing backup files:", "Existing backup files:"},
			{"Backup files are deleted!", "Backup files are deleted!"},
			{"No file to delete!", "No file to delete!"},
			{"Backup this project!", "Backup this project!"},
			{"Have you saved this project before?", "Have you saved this project before?"},
			{"If yes, click OK button to backup this project!", "If yes, click OK button to backup this project!"},
			{"Backup successful", "Backup successful"},
			{"Backup created successfully:", "Backup created successfully:"},
			{"Backup failed", "Backup failed"},
			{"Failed to create backup. Check file permissions.", "Failed to create backup. Check file permissions."},
			{"Backup notes updated!", "Backup notes updated!"},
			{"Backup project notes:", "Backup project notes:"},
			{"Folder does not exists: ", "Folder does not exists: "},
			{"No such file or directory", "No such file or directory"},
			{"Unable to open file:", "Unable to open file:"},
			{"Project script data", "Project script data"},
			{"Load notes", "Load notes"},
			{"Clear notes", "Clear notes"},
			{"Input notes", "Input notes"},
			{"Add new line", "Add new line"},
			{"Clean old", "Clean old"},
			{"Backup", "Backup"},
		},
	}
end

-- Define a class "NotesObject"
NotesObject = {
	playBack = nil,
	playHeadPosition = nil,
	displayVersion = true,	-- display version
	displayAuthor = false,	-- display author
	errorMessages = {},
	hostinfo = nil,
	osType = "",
	osName = "",
	hostName = "",
	languageCode = "", 
	hostVersion = "",
	hostVersionNumber = 0,
	debug = false,
	backupTag = "BACKUP:",
	scriptDataKey = "BackupProjectNotes",
	backupTemplate = "_BACKUP_",
	fileExtension= ".svp",
	projectFilename = "",
	OldProjectFilename = "",
	scriptDataKeys = {},
	scriptDataKeysList = {},
	MAX_AUTO_BACKUPS = 5,				-- Maximum number of automatic backups to keep
	INCLUDE_TIMESTAMP = true,			-- Add timestamp to backup names
	controls = {},						-- controls panel
	clearButtonValue = nil, 			-- button Clear notes
	loadButtonValue = nil, 				-- button load notes
	showFormButtonValue = nil, 			-- button show form
	cleanOldBackupButtonValue = nil,	-- button clean old backup
	backupButtonValue = nil, 			-- button backup 
	newLineButtonValue = nil, 			-- button new line
	statusTextValue = nil,   			-- text panel
	projectNotesTextValue = nil,		-- project notes text panel
	projectNotes = "",
	backupProjectDataInfosTextValue = nil, -- backup data infos text panel
	backupProjectDataInfos = "",
	infosToDisplay = "",
	logs = {}
}

-- Constructor method for the NotesObject class
function NotesObject:new()
    local notesObject = {}
    setmetatable(notesObject, self)
    self.__index = self
	
	self:getHostInformations()
	
	self.controls = self:getControls()	
	self:initializeControlsValues()
	self:setControlsCallback()
	
	self.clearButtonValue = SV:create("WidgetValue")
	self.showFormButtonValue = SV:create("WidgetValue")
	self.cleanOldBackupButtonValue = SV:create("WidgetValue")
	self.loadButtonValue = SV:create("WidgetValue")
	self.backupButtonValue = SV:create("WidgetValue")
	self.newLineButtonValue = SV:create("WidgetValue")
	
	self.statusTextValue = SV:create("WidgetValue")
	self.statusTextValue:setValue("")
	self.statusTextValue:setEnabled(false)

	self.projectNotesTextValue = SV:create("WidgetValue")
	self.projectNotesTextValue:setValue("")
	self.projectNotesTextValue:setEnabled(false)

	self.backupProjectDataInfosTextValue = SV:create("WidgetValue")
	self.backupProjectDataInfosTextValue:setValue("")
	self.backupProjectDataInfosTextValue:setEnabled(false)
	
	self:setButtonClearControlCallback()
	self:setButtonLoadControlCallback()
	self:setButtonBackupControlCallback()
	self:setButtonNewLineControlCallback()
	self:setButtonShowFormControlCallback()
	self:setButtonCleanOldBackupControlCallback()
	
	local infos = getClientInfo()

	self.infosToDisplay = ""
	if self.displayVersion then
		self.infosToDisplay = self.infosToDisplay .. SV:T("Version") .. ": " ..  infos.versionNumber
		if self.displayAuthor then
			self.infosToDisplay = self.infosToDisplay .. " - " .. SV:T("author") .. ": " .. infos.author
		end
	end
	-- self.infosToDisplay = self.infosToDisplay .. SV:T("minEditorVersion") .. ": " ..  infos.minEditorVersion
	self:addTextPanel(self.infosToDisplay)
	self:setProjectNotesTextPanel(self.projectNotes)
	
	-- Register arrangement selection callback
	self:registerArrangementSelectionCallback()
	
    return self
end

-- Register arrangement selection callback
function NotesObject:registerArrangementSelectionCallback()
	
	-- Register selection callback to load parameters when selection changes
	SV:getArrangement():getSelection():registerSelectionCallback(function(selectionType, isSelected)
		self.groupsSelected = self:getSelectedGroups()
		if #self.groupsSelected > 0 then
			self:displayBackupNotes()
		end
	end)
	
	-- Register clear selection callback
	SV:getArrangement():getSelection():registerClearCallback(function(selectionType)
		-- No group selected in arrangement view
	end)
end

-- Display backup notes
function NotesObject:displayBackupNotes()
	local infos = ""
	self.projectFilename = self:getProject():getFileName()
	self.projectNotes = self:getProjectData()
	self.backupProjectDataInfos = self:getProjectScriptDataKeys()
	
	if self.OldProjectFilename == self.projectFilename then
		local newVal = self.projectNotesTextValue:getValue()
		if #newVal > 0 then
			self.projectNotes = newVal
		end
	else
		self.controls.scriptDataKeys.value:setValue(0)
		self.backupProjectDataInfosTextValue:setValue("")
	end
	if #self.projectNotes > 0 then
		self:setProjectNotesTextPanel(self.projectNotes)
		infos = infos .. SV:T("Backup notes loaded!") .. " (" .. #self.projectNotes .. " " .. SV:T("chars") .. ")"		
	else
		self:setProjectNotesTextPanel("")
		infos = infos .. SV:T("No backup notes!")
	end
	if #self.backupProjectDataInfos > 0 then
		infos = infos .. "\r" .. self.backupProjectDataInfos
	end
	self:displayMessage(infos)
	self.OldProjectFilename = self.projectFilename
	SV:refreshSidePanel()
end

-- Show message dialog
function NotesObject:show(message)
	SV:showMessageBox(SV:T(SCRIPT_TITLE), message)
end

-- Show message dialog async
function NotesObject:showAsync(message)
	SV:showMessageBoxAsync(SV:T(SCRIPT_TITLE), message, function() self:ShowResponse(message) end)
end

-- Show response
function NotesObject:ShowResponse(message)
	self:addTextPanel(message)
end

-- Read file content
function NotesObject:readAll(file)
    local f = assert(io.open(file, "rb"))
    local content = f:read("*all")
    f:close()
    return content
end

-- Get selected groups
function NotesObject:getSelectedGroups()	
	return SV:getArrangement():getSelection():getSelectedGroups()
end

-- Get current track
function NotesObject:getCurrentTrack()
	return SV:getMainEditor():getCurrentTrack()
end

-- Get timeAxis
function NotesObject:getTimeAxis()
	return self:getProject():getTimeAxis()
end

-- Get project
function NotesObject:getProject()
	return SV:getProject()
end

-- Add log into self.logs
function NotesObject:addLogs(message)
	table.insert(self.logs, message)
end

-- Display logs into panel
function NotesObject:addLogsInPanel()
	for i = 1, #self.logs do
		self:addTextPanel(self.logs[i])
	end
end

-- Set project notes text in panel
function NotesObject:setProjectNotesTextPanel(projectNotes)
	self.projectNotesTextValue:setValue(projectNotes)
end

-- Display message box in panel
function NotesObject:addTextPanel(message)
	local old = self.statusTextValue:getValue()
	local sepLine = "\r"
	if #old > 0 then
		message = old .. sepLine .. message
	end
	self.statusTextValue:setValue(message)
end

-- Clear display message in panel
function NotesObject:clearTextPanel()
	self.statusTextValue:setValue("")
end

-- Store error message
function NotesObject:error(message)
	table.insert(self.errorMessages, message)
end

-- set project modified
function NotesObject:setProjectUpdated()
	local currentTrack = self:getCurrentTrack()
	currentTrack:setName(currentTrack:getName())	
end

-- Clear user project data
function NotesObject:clearProjectData()
	self.projectNotes = ""
	self:getProject():setScriptData(self.scriptDataKey, self.projectNotes)
end

-- Save user project data
function NotesObject:saveProjectData()
	self.projectNotes = self.projectNotesTextValue:getValue()
	self:getProject():setScriptData(self.scriptDataKey, self.projectNotes)	
end

-- Get user project data
function NotesObject:getProjectData()
	local projectData = ""
	if #self.projectFilename > 0 then
		projectData = self:getProject():getScriptData(self.scriptDataKey) or ""
	end
	return projectData
end

-- Get script data keys
function NotesObject:getProjectScriptDataKeys()
	local backupProjectDataInfos = ""
	local otherKeysCount = 0
	self.scriptDataKeys = SV:getProject():getScriptDataKeys()
	self.scriptDataKeysList = {}
	if #self.scriptDataKeys > 1 then
		table.insert(self.scriptDataKeysList, SV:T("See other project keys"))
		if #self.projectFilename > 0 then
			for _, key in ipairs(self.scriptDataKeys) do
				if key ~= self.scriptDataKey then
					local val = SV:getProject():getScriptData(key)
					backupProjectDataInfos = backupProjectDataInfos .. key .. " (" .. #val .. " " .. SV:T("chars") .. ")" .. "\r"
					otherKeysCount = otherKeysCount + 1
					table.insert(self.scriptDataKeysList, key)
				end
			end
		end
		if #backupProjectDataInfos > 0 then
			backupProjectDataInfos = SV:T("Scripts project keys found:") .. " " .. otherKeysCount .. "\r"
		end
	else
		table.insert(self.scriptDataKeysList, SV:T("No other project keys"))
	end
	return backupProjectDataInfos
end

-- Get controls panel
function NotesObject:getControls()

	local controls = {
		scriptDataKeys = {
			value = SV:create("WidgetValue"),
			defaultValue = 0, 
			paramKey = "scriptDataKeys"
		}
	}
	return controls
end

-- Initialize widget values
function NotesObject:initializeControlsValues()
	-- Initialize widget values
	for key, control in pairs(self.controls) do
		control.value:setValue(control.defaultValue)
		-- self:addLogs(key .. "=" .. tostring(control.defaultValue))
		-- self:addLogs(key .. "=" .. self:getObjectProperties(control))
	end
end

-- Set controls callback
function NotesObject:setControlsCallback()
	for key, control in pairs(self.controls) do
		control.value:setValueChangeCallback(function()
			-- self:addLogsInPanel()
			if control.paramKey == "scriptDataKeys" then
				if self.controls.scriptDataKeys.value:getValue() > 0 then
					local keyName = self.scriptDataKeysList[self.controls.scriptDataKeys.value:getValue() + 1]
					local keyData = self:getProject():getScriptData(keyName)
					-- self:show(keyName .. ":" .. "\r" .. tostring(keyData))
					self.backupProjectDataInfosTextValue:setValue(keyName .. ":" .. "\r" .. tostring(keyData))
				else
					self.backupProjectDataInfosTextValue:setValue("")
				end
			end
		end
		)
	end
end

-- Set button Clear control callback
function NotesObject:setButtonClearControlCallback()

	-- Button load notes
	self.clearButtonValue:setValueChangeCallback(function()
			local bResult = SV:showOkCancelBox(SV:T(SCRIPT_TITLE),
					SV:T("CLEAR backup notes, ARE YOU SURE?")
					.. "\r\r" .. SV:T("Cancel => to abort")
				)
			if bResult then

				self:getProject():newUndoRecord()
				self:setProjectUpdated()
				self:clearProjectData()
				self:setProjectNotesTextPanel(self.projectNotes)
				self:displayMessage(SV:T("Backup notes cleared!") .. "\r" .. SV:T("Remember to save this project!"))
			end
		end
	)
end

-- Set button Load control callback
function NotesObject:setButtonLoadControlCallback()

	-- Button load notes
	self.loadButtonValue:setValueChangeCallback(function()
			self:displayBackupNotes()
			-- SV:refreshSidePanel()
		end
	)
end

-- Set button show form
function NotesObject:setButtonShowFormControlCallback()

	-- Button Save notes
	self.showFormButtonValue:setValueChangeCallback(function()
			local title = SV:T("Backup project notes!") .. "\r" .. SV:T(" Click OK button to save backup notes!")
			
			local userInput = self:showForm(title, self.projectNotes)
			if userInput.status then
				self.projectNotes = userInput.answers.notes
				self.projectNotesTextValue:setValue(self.projectNotes)
				self:saveProjectData()
				self:setProjectUpdated()
				self:displayMessage(SV:T("Backup notes saved!") .. "\r" .. SV:T("Remember to save this project!"))
			end
		end
	)
end

-- Clean old backup Button
function NotesObject:setButtonCleanOldBackupControlCallback()

	-- Button Save notes
	self.cleanOldBackupButtonValue:setValueChangeCallback(function()
			local title = SV:T("Clean old backup files!")
			local message = SV:T("Click OK button to delete old backup files!")
			local result = SV:showOkCancelBox(title, message)
			if result then

				self.projectFilename = self:getProject():getFileName()
				local deletedFilesCount, allFiles, deletedFiles = self:cleanOldBackups(self.projectFilename)
				local existingFiles = ""
				if #allFiles > 0 then
					existingFiles = "\r" .. SV:T("Existing backup files:")
				end
				if deletedFilesCount > 0 then
					local resultMessage = SV:T("Backup files are deleted!") .. " (" .. deletedFilesCount .. ")" 
										.. existingFiles  .. " " .. #allFiles - deletedFilesCount
					self:displayMessage(resultMessage)
					self:show(resultMessage)
					-- self:show(resultMessage .. "\r" .. table.concat(deletedFiles, "\r"))
				else
					local resultMessage = SV:T("No file to delete!") .. existingFiles
					self:displayMessage(resultMessage)
					self:show(resultMessage)
				end
			end
		end
	)
end

-- Set button backup control callback
function NotesObject:setButtonBackupControlCallback()

	-- Button Backup
	self.backupButtonValue:setValueChangeCallback(function()
			local projectFilename = self:getProject():getFileName()
			if #projectFilename == 0 then
				self:show("Save this project first!")
			else
				local title = SV:T("Backup this project!")
				local message = SV:T("Have you saved this project before?")
					.. "\r" .. SV:T("If yes, click OK button to backup this project!")
				local result = SV:showOkCancelBox(title, message)
				if result then
					-- self:getProject():newUndoRecord()
					self:saveProjectData()
					local timeStamp = self:getTimestamp()
					self.backupProjectDataInfos = self.backupTag .. " " .. timeStamp
					
					-- Create backup
					local success, backupPath = self:createBackup(timeStamp)

					if success then
						local backupDir, projectName = self:extractPathInfo(backupPath)
						self:displayMessage(SV:T("Backup successful") .. "\r"
							.. SV:T("Backup created successfully:") .. "\r" .. projectName)
					else
						self:show(
							SV:T("Backup failed") .. "\r"
							.. SV:T("Failed to create backup. Check file permissions.")
						)
					end				
				end				
			end
		end
	)
end

-- Set button new line callback
function NotesObject:setButtonNewLineControlCallback()

	-- Button new line
	self.newLineButtonValue:setValueChangeCallback(function()
			self:getProject():newUndoRecord()
			local newVal = self.projectNotesTextValue:getValue()
			if #newVal > 0 then
				self.projectNotes = newVal
			end
			self.projectNotes = self.projectNotes .. "\r\n" .. ""
			self.projectNotesTextValue:setValue(self.projectNotes)
			self:saveProjectData()
			self:setProjectUpdated()
			self:displayMessage(SV:T("Backup notes updated!"))
		end
	)
end

-- Show custom dialog box
function NotesObject:showForm(title, notes)
	local form = {
		title = SV:T(SCRIPT_TITLE),
		message = title,
		buttons = "OkCancel",
		widgets = {
			{
				name = "notes", type = "TextArea", label = SV:T("Backup project notes:"),
				height = 400,
				default = notes
			},
			{
				name = "separator", type = "TextArea", label = "", height = 0
			}
		}
	}
	self.dialogTitle = title
	self.onResponse = function(response) self:dialogResponse(response) end
	return SV:showCustomDialog(form)
end

-- Display message
function NotesObject:displayMessage(message)
	self:clearTextPanel()
	self:addTextPanel(self.infosToDisplay)
	self:addTextPanel(message)
end
	
-- Display error messages
function NotesObject:displayErrors()
	local result = ""
	if #self.errorMessages > 0 then
		for _, m in pairs(self.errorMessages) do
			result = result .. m .. "\r"
		end
	end
	return result
end

-- Get host informations
function NotesObject:getHostInformations()
	self.hostinfo = SV:getHostInfo()
	self.osType = self.hostinfo.osType  -- "macOS", "Linux", "Unknown", "Windows"
	self.osName = self.hostinfo.osName
	self.hostName = self.hostinfo.hostName
	self.languageCode = self.hostinfo.languageCode
	self.hostVersion = self.hostinfo.hostVersion
	self.hostVersionNumber = self.hostinfo.hostVersionNumber
end

-- Get object properties (debug only)
function NotesObject:getObjectProperties(obj, level)
	local result = ""
	local level = level or 0
	local maxLevel = 3
	level = level + 1
	
	for k, v in pairs(obj) do
		if obj[k] ~= nil then
			result = result .. "(level: " .. level .. ") " .. k .. "=" .. tostring(v) .. "\r"
			if type(v) == "table" then
				-- result = result .. ", size:" .. #v .. ": "
				if level < maxLevel then
					result = result .. self:getObjectProperties(v, level) .. "\r"
				else
					result = result .. "\r"
				end
			end
		end
	end
	return result
end

-- Create a backup of the project
function NotesObject:createBackup(timeStamp)
	-- Extract project directory and filename
	self.projectFilename = self:getProject():getFileName()
	local backupDir, projectName = self:extractPathInfo(self.projectFilename)
	local projectBaseName = projectName:match("(.+)%..+$") or self.projectFilename
	local iBackupPos = string.find(projectBaseName, self.backupTemplate)
	local backupFileName = ""
	
	if iBackupPos == nil then
		-- Timestamped Backup 
		backupFileName = projectBaseName .. self.backupTemplate .. timeStamp .. ".svp"
	else
		projectBaseName = string.sub(projectBaseName, 1, iBackupPos - 1)
		backupFileName = projectBaseName .. self.backupTemplate .. timeStamp .. ".svp"
	end
	-- Generate backup filename based on type
	local backupPath = backupDir .. "/" .. backupFileName

	-- Copy project file
	local success = self:copyFile(self.projectFilename, backupPath)
	
	return success, backupPath
end

-- Clean old auto-backups
function NotesObject:cleanOldBackups(projectPath)	
	local dir = {}
	local full_dir = {}
	local deletedFiles = {}
	local deletedFilesCount = 0
	local backupDir, projectName = self:extractPathInfo(projectPath)
	local projectBaseName = projectName:match("(.+)%..+$") or projectPath
	
	if not self:isFolderExists(backupDir) then
		self:show(SV:T("Folder does not exists: ") .. backupDir)
		return deletedFilesCount
	end

	-- Get list of auto-backup files
	local backups = {}
	local pattern = projectBaseName .. self.backupTemplate .. "*" .. self.fileExtension
	local dir2, full_dir2 = self:listFiles(backupDir .. pattern, self.fileExtension, backupDir)

	if #full_dir2 > 0 then
		for k, filePath in pairs(full_dir2) do
			table.insert(dir, dir2[k])
			table.insert(full_dir, filePath)
		end
	end
	
	if #full_dir > 0 then
		-- Sort backups by number (newest first)
		local regEx = "(%d+)_(%d+)" .. "(" .. self.fileExtension .. ")"
		table.sort(full_dir, function(a, b)
			local aDate, aTime = a:match(regEx)
			local bDate, bTime = b:match(regEx)
			local numA = aDate .. aTime
			local numB = bDate .. bTime
			return tonumber(numA) > tonumber(numB)
		end)
		
		-- Delete old backups beyond self.MAX_AUTO_BACKUPS
		for i = 1, #full_dir do
			if i > self.MAX_AUTO_BACKUPS  then
				self:deleteFile(full_dir[i])
				table.insert(deletedFiles, full_dir[i])
				deletedFilesCount = deletedFilesCount + 1
			end
		end
	end
	return deletedFilesCount, full_dir, deletedFiles
end

-- Get timestamp string
function NotesObject:getTimestamp()
	return os.date("%Y%m%d_%H%M%S")
end

-- Extract directory and filename from full path
function NotesObject:extractPathInfo(fullPath)
	local dir = fullPath:match("(.*/)")
	if not dir then
		dir = fullPath:match("(.*\\)")
	end
	if not dir then
		dir = "./"
	end
	local filename = fullPath:match("[^/\\]+$")
	return dir, filename
end

-- Check if file exists
function NotesObject:fileExists(path)
	local file = io.open(path, "r")
	if file then
		file:close()
		return true
	end
	return false
end

-- Check if folder exists
function NotesObject:isFolderExists(folderName)
  local fileHandle, error = io.open(folderName .. "/*.*", "r")
  if fileHandle ~= nil then
    io.close(fileHandle)
    return true
  else
	-- be carefull! Text returned by os system
    if string.match(error, SV:T("No such file or directory")) then
      return false
    else
      return true
    end
  end
end

-- Save text file
function NotesObject:saveTextFile(text, filename)
	local result = false
	local fo, errMessage = io.open(filename, "w")
	if fo then
	  fo:write(text)
	  fo:close()
	  result = true
	end
	return result
end

-- Read text file
function NotesObject:readTextFile(file)
	local arr = {}
	local err = false
	local handle, errMessage = io.open(file,"r")
	if handle then
		local value = handle:read("*line")
		while value do
			table.insert(arr, value)
			value = handle:read("*line")
		end
		handle:close()
	else
		err = true
	end
  return arr, err, errMessage
end

-- Copy file
function NotesObject:copyFile(source, destination)
	local result = false
	local sourceLines, err, errMessage = self:readTextFile(source)
	if err then
		self.show(SV:T("Unable to open file:") .. "\r" .. errMessage)
	else
		local newFileContent = table.concat(sourceLines, "\n")
		result = self:saveTextFile(newFileContent, destination)
	end

	return result, destination
end

-- Delete file
function NotesObject:deleteFile(path)
	local os_name = package.config:sub(1,1) == '\\' and 'windows' or 'unix'

	if os_name == 'windows' then
		os.execute('del /Q "' .. path .. '" >nul 2>&1')
	else
		os.execute('rm "' .. path .. '" 2>/dev/null')
	end
end

-- List files in folder
function NotesObject:listFiles(directory, fileExtension, path)
    local i, dir, popen = 0, {}, io.popen
	local full_dir = {}
    local pfile
	
	if self.osType ~= "Windows" then
		local tempfilename = os.tmpname()
		os.execute([[ls -d ]] .. directory .. [[*/ >> ]] .. tempfilename)
		
		if self:isFileExists(tempfilename) then
			pfile = lines_from(tempfilename)
			os.remove(tempfilename)
			
			for _,foldername in pairs(pfile) do
				local testname = string.lower(foldername)
				if string.find(testname,"ignore") == nil then
					if string.find(testname, fileExtension, 1, true) ~= nil then
						foldername = string.gsub(foldername,"//","/")
						i = i + 1
						full_dir[i] = foldername
						local start = 0, searchnew, searchold
						
						while true do
						  start = string.find(foldername, "/", start+1)    -- find 'next' newline
						  if start == nil then break end
						  searchold = searchnew
						  searchnew = start
						end
						dir[i] = string.sub(foldername,searchold+1)		
						dir[i] = string.gsub(dir[i],"/","")
					end					
				end	
			end
		end	
	else
		local cmd = 'dir "'..directory..'" /b'
		pfile = popen(cmd)
		for filename in pfile:lines() do
			local testname = string.lower(filename)
			if string.find(testname,"ignore") == nil then
				if string.find(testname, fileExtension, 1, true) ~= nil then
					i = i + 1
					dir[i] = filename
					full_dir[i] = path .. filename
				end
			end			
		end
		pfile:close()
		
	end	
    return dir, full_dir
end

-- Get section
function NotesObject:getSection()
	local projectScriptDataChoice = {}
	local backupProjectDataInfosTextValue = {}
	
	if #self.scriptDataKeysList > 1 then
		projectScriptDataChoice = {
					type = "Container",
					columns = {
						{
							type = "ComboBox",
							text = SV:T("Project script data"),
							value = self.controls.scriptDataKeys.value,
							choices = self.scriptDataKeysList,
							width = 1.0
						}
					}
				}
				
		backupProjectDataInfosTextValue = {
					type = "Container",
					columns = {
						{
							type = "TextArea",
							value = self.backupProjectDataInfosTextValue,
							height = 70,
							width = 1.0,
							readOnly = false
						}
					}
				}
	end
	
	-- Define CheckBox & button & textarea
	local section = {
		title = SV:T(SCRIPT_TITLE),
		rows = {
			{
				type = "Container",
				columns = {
					{
						type = "Button",
						text = SV:T("Load notes"),
						width = 0.5,
						value = self.loadButtonValue
					},
					{
						type = "Button",
						text = SV:T("Clear notes"),
						width = 0.5,
						value = self.clearButtonValue
					}
				}
			},
			{
				type = "Container",
				columns = {
					{
						type = "TextArea",
						value = self.projectNotesTextValue,
						height = 200,
						width = 1.0,
						readOnly = false
					}
				}
			},
			{
				type = "Container",
				columns = {
					{
						type = "Button",
						text = SV:T("Input notes"),
						width = 0.5,
						value = self.showFormButtonValue
					},
					{
						type = "Button",
						text = SV:T("Add new line"),
						width = 0.5,
						value = self.newLineButtonValue
					}
				}
			},
			{
				type = "Container",
				columns = {
					{
						type = "Button",
						text = SV:T("Clean old"),
						width = 0.5,
						value = self.cleanOldBackupButtonValue
					},
					{
						type = "Button",
						text = SV:T("Backup"),
						width = 0.5,
						value = self.backupButtonValue
					},
				}
			},
			{
				type = "Container",
				columns = {
					{
						type = "TextArea",
						value = self.statusTextValue,
						height = 80,
						width = 1.0,
						readOnly = true
					}
				}
			},
			projectScriptDataChoice,
			backupProjectDataInfosTextValue
		}
	}
	return section
end

-- Get panel section state
function NotesObject:getPanelSectionState()

	self.clearButtonValue:setEnabled(true)
	self.loadButtonValue:setEnabled(true)
	self.showFormButtonValue:setEnabled(true)
	self.cleanOldBackupButtonValue:setEnabled(true)
	self.backupButtonValue:setEnabled(true)
	self.newLineButtonValue:setEnabled(true)
	
	local errors = self:displayErrors()
	if #errors > 0 then
		self:addTextPanel(errors)
	end
	
	-- Get section data
	local section = self:getSection()

	return section
end

-- Initialize main internal object	
local notesObject = NotesObject:new()

-- Get panel section state called by Synthesizer V internal system
function getSidePanelSectionState()
	
	local section = notesObject:getPanelSectionState()
	return section
end
